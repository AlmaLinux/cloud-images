---
# tasks file for mounting chroot
- name: Create chroot directory
  ansible.builtin.file:
    path: /rootfs
    state: directory

- name: Mount chroot root partition
  ansible.builtin.command: mount /dev/nvme1n1p3 /rootfs
  changed_when: true
  args:
    warn: false

- name: Create chroot boot directory
  ansible.builtin.file:
    path: /rootfs/boot
    state: directory

- name: Mount chroot boot partition
  ansible.builtin.command: mount /dev/nvme1n1p2 /rootfs/boot
  changed_when: true
  args:
    warn: false

- name: Create chroot device directory
  ansible.builtin.file:
    path: /rootfs/dev
    state: directory

- name: Mount chroot device files
  ansible.builtin.command: mount -o bind /dev /rootfs/dev
  args:
    warn: false
  changed_when: true

- name: Create chroot sys directory
  ansible.builtin.file:
    path: /rootfs/sys
    state: directory

- name: Mount chroot sysfs
  ansible.builtin.command: mount -t sysfs sysfs /rootfs/sys
  args:
    warn: false
  changed_when: true

- name: Creating the rootfs directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
  loop:
    - /rootfs/boot/efi
    - /rootfs/dev/pts
    - /rootfs/dev/shm
    - /rootfs/proc
    - /rootfs/sys/fs/selinux

- name: Mount chroot ESP
  ansible.builtin.command: mount /dev/nvme1n1p1 /rootfs/boot/efi
  args:
    warn: false
  changed_when: true

- name: Mount chroot pseudo filesystems
  ansible.builtin.command: mount -t {{ item.type }} {{ item.src }} {{ item.dest }}
  args:
    warn: false
  changed_when: true
  loop:
    - { type: 'devpts', src: 'devpts', dest: '/rootfs/dev/pts' }
    - { type: 'tmpfs', src: 'tmpfs', dest: '/rootfs/dev/shm' }
    - { type: 'proc', src: 'proc', dest: '/rootfs/proc' }
    - { type: 'selinuxfs', src: 'selinuxfs', dest: '/rootfs/sys/fs/selinux' }
