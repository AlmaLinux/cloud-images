---
- name: Enable opennebula-addons repositroy
  ansible.builtin.dnf:
    name: almalinux-release-opennebula-addons
    state: present

- name: Install OpenNebula Linux VM Contextualization
  ansible.builtin.dnf:
    name: one-context
    state: present

- name: Enable one-context and network services for 8
  ansible.builtin.service:
    name: "{{ item }}"
    enabled: true
  loop:
    - one-context
    - network
  when: ansible_facts['distribution_major_version'] == '8'

- name: Enable one-context services for 9
  ansible.builtin.service:
    name: one-context
    enabled: true
  when: ansible_facts['distribution_major_version'] == '9'

- name: Install disk resize dependencies
  ansible.builtin.package:
    name:
      - cloud-utils-growpart
      - parted
    state: present

- name: Regenerate the initramfs
  ansible.builtin.command: dracut -f --regenerate-all
  changed_when: true
